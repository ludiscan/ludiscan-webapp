name: Auto Draft PR

on:
  push:
    branches:
      - 'claude/**'
      - 'work/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-draft-pr:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH_NAME"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found for branch $BRANCH_NAME"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Determine base branch
        id: base-branch
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          # Check if develop branch exists
          if git ls-remote --heads origin develop | grep -q develop; then
            echo "base=develop" >> $GITHUB_OUTPUT
          else
            echo "base=main" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR title from branch name
        id: pr-title
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # Remove prefix (claude/ or work/)
          TITLE_BASE="${BRANCH_NAME#claude/}"
          TITLE_BASE="${TITLE_BASE#work/}"
          # Remove session ID suffix (e.g., -qSscD at the end)
          TITLE_BASE=$(echo "$TITLE_BASE" | sed 's/-[a-zA-Z0-9]\{5\}$//')
          # Convert kebab-case to sentence case
          TITLE=$(echo "$TITLE_BASE" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/')
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create draft PR
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          gh pr create \
            --draft \
            --base "${{ steps.base-branch.outputs.base }}" \
            --head "$BRANCH_NAME" \
            --title "${{ steps.pr-title.outputs.title }}" \
            --body "$(cat <<'EOF'
          ## Summary

          _Auto-generated draft PR for branch `${{ github.ref_name }}`_

          ## Changes

          <!-- Describe your changes here -->

          ## Test plan

          - [ ] Tests pass locally
          - [ ] Lint and type checks pass
          EOF
          )"
        env:
          GH_TOKEN: ${{ github.token }}
