# 画面分割機能 仕様書（v1.2 / 同一路径内で分割）

## 1. ルーティング

* ページは**現行のまま**：`/heatmap/projects/[projectId]`
* 分割は**ページ内モード**として有効化

  * URLクエリで状態を保持：

    * `vm=split`（分割ON）/ `vm=single`（通常）
    * `left=ses:123&right=ses:456`（割当）
    * `link=time,camera`（リンク種）
    * `dtL=0&dtR=3`（オフセット）
    * 例：`/heatmap/projects/abc?vm=split&left=ses:1&right=ses:2&link=time,camera&dtL=0&dtR=2`
  * 完全保存が必要なときは `layout=`（LayoutTree+panes を base64url）を使用

## 2. 画面構成（同一路径）

* **上部バー（既存に追加）**：

  * 分割トグル `Split Mode`（ONで2Pane表示）
  * リンクトグル：Time / Camera / Filter / Selection
  * Δt 入力（Left/Right）
  * 再生制御：Play/Pause, Speed(0.5/1/2)
* **メイン（単一 `<canvas>` / 複数 viewport）**：

  * v1：**左右2Pane固定**（次で上下/4Pane拡張）
  * クリック時の**ピン・エフェクト**（2秒）
* **ボトムメニュー（既存 Session Picker）**：

  * **アクティブPane**へクリック割当
  * 先行MVPはクリックのみ（D&Dは拡張）

## 3. 同期モデル

* **時間**：`Tg`（グローバル）／`Tp = Tg + Δt(p)`（Pane毎）。`link.time=false` はローカル時刻。
* **カメラ**：アクティブPaneの `{pos,target,fov}` を共有。`link.camera=true` は補間追従。
* **フィルタ/選択**：プロジェクト共通をグローバル、Pane追加フィルタは任意。リンクONで同期。

## 4. 状態設計（Redux 例：heatmapCanvas 内に統合）

```ts
type ViewMode = 'single' | 'split';

type CompareGlobal = {
  mode: ViewMode;                // ← 追加
  timeSec: number; playing: boolean; speed: 0.5 | 1 | 2;
  activePaneId: 'left' | 'right' | null;
  filter: ProjectFilter; selection: ProjectSelection;
};

type PaneState = {
  id: 'left' | 'right';
  sessionId: string | null;      // 同一project内のみ
  timeOffsetSec: number;
  link: { time: boolean; camera: boolean; filter: boolean; selection: boolean };
  camera: { pos: [number, number, number]; target: [number, number, number]; fov: number };
  overlay: { heatmap: boolean; heatmapOpacity: number };
};

type LayoutTree = {
  type: 'split',
  dir: 'row',
  a: { type: 'leaf', paneId: 'left' },
  b: { type: 'leaf', paneId: 'right' }
};

type CompareState = {
  projectId: string;
  global: CompareGlobal;
  panes: Record<'left' | 'right', PaneState>;
  layout: LayoutTree; // v1固定だが将来拡張OK
};
```

## 5. URL／起動時の復元

* ページマウント時にクエリをパース → `mode/link/dt/left/right` をストアへ反映
* `mode=split` で無割当の場合は「ボトムからセッションを選んでください」空状態を表示
* 履歴操作（戻る/進む）で**UI状態を完全復元**

## 6. レンダリング（単一Renderer・複数Viewport）

* 同一`renderer`で `setViewport/setScissor` により左右描画
* モデル/材質/ジオメトリは**共有参照**
* 入力座標→どのPaneのrectか判定してRaycaster実行（**アクティブPane**更新）

## 7. データ取得・再生

* 同一 `projectId` のセッションをまとめ取得（既存API流用）
* 0.2s座標/イベントをPaneごとバッファ。欠損はギャップ扱い。
* 線形補間（閾値超過は補間しない）

## 8. UX 要点

* **アクティブPane**枠ハイライト、`Tab`切替 / `Cmd+←/→`で左右選択
* ボトムのセッションを**クリック**→アクティブPaneに割当
* Δtはステップ0.1s、入力確定時にURL更新（ディープリンク維持）

## 9. パフォーマンス

* LOD/インスタンシング、Worker前処理（解凍/リサンプ）→Transferable共有
* `devicePixelRatio`考慮で描画サイズ最適化
* ピッキングは**アクティブPaneのみ**

## 10. エッジケース

* **異なるprojectのセッションは割当不可**（Picker側で非表示）
* 同一セッションの**両Pane割当は許可**（フィルタ違い比較に使う）
* セッション長不一致：短い側は末尾停止／グレー帯表示

## 11. テレメトリ（イベント名だけ更新）

* `compare_mode_toggle`（on/off）
* `assign_session`（pane, sessionId）
* `toggle_link` / `set_dt` / `seek` / `play`
* `render_p95_ms`（per frame / per pane）

## 12. 実装タスク（v1：2Pane固定）

1. `heatmapCanvas.compare` ステート追加（上記型）
2. 既存ページに**Split Modeトグル**とリンクUIを追加
3. 単一canvasで**左右Viewport描画**
4. BottomSessionPicker→**アクティブPane割当**
5. タイムライン同期（Timeリンク＋Δt）／ピン・エフェクト
6. URLクエリ⇄ストア 同期（起動復元・履歴対応）

